{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/articles/2019-03/React-snap-puppeteer-no-sandbox","webpackCompilationHash":"8aeaabf65ab5b4d6a17f","result":{"data":{"site":{"siteMetadata":{"title":"GyeongSu Han's Github Pages","author":"@micalgenus","siteUrl":"https://micalgenus.github.io"}},"markdownRemark":{"id":"4979c62c-7144-511c-a0a6-5453921cf842","html":"<p>React snap을 사용할 때, 리눅스에서 puppeteer에서 에러가 발생하는 경우가 있습니다. no-sandbox를 옵션으로 주어야 하기 때문에 발생하는데, 이를 <code class=\"language-text\">pacakge.json</code>에 옵션으로 주게되면 해결하였습니다.</p>\n<p>먼저, <code class=\"language-text\">react-snap</code>을 실행하면 수행하는 스크립트를 알아보겠습니다. <strong>./node_modules/react-snap/package.json</strong>을 보면 다음과 같이 스크립트가 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"bin\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"react-snap\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./run.js\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 이 파일을 보게되면,</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">#<span class=\"token operator\">!</span><span class=\"token operator\">/</span>usr<span class=\"token operator\">/</span>bin<span class=\"token operator\">/</span>env node\n\n<span class=\"token keyword\">const</span> url <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'url'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> run <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./index.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> reactSnap<span class=\"token punctuation\">,</span> homepage<span class=\"token punctuation\">,</span> devDependencies<span class=\"token punctuation\">,</span> dependencies <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>process<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/package.json</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> publicUrl <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">PUBLIC_URL</span> <span class=\"token operator\">||</span> homepage<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> reactScriptsVersion <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>devDependencies <span class=\"token operator\">&amp;&amp;</span> devDependencies<span class=\"token punctuation\">[</span><span class=\"token string\">'react-scripts'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>dependencies <span class=\"token operator\">&amp;&amp;</span> dependencies<span class=\"token punctuation\">[</span><span class=\"token string\">'react-scripts'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> fixWebpackChunksIssue<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>reactScriptsVersion<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">case</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n    fixWebpackChunksIssue <span class=\"token operator\">=</span> <span class=\"token string\">'CRA1'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">case</span> <span class=\"token number\">2</span><span class=\"token punctuation\">:</span>\n    fixWebpackChunksIssue <span class=\"token operator\">=</span> <span class=\"token string\">'CRA2'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  publicPath<span class=\"token punctuation\">:</span> publicUrl <span class=\"token operator\">?</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>publicUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>pathname <span class=\"token punctuation\">:</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n  fixWebpackChunksIssue<span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">...</span>reactSnap<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>와 같이 작성되어있습니다. <code class=\"language-text\">package.json</code>에서 <strong>reactSnap</strong>설정을 불러오고, 이를 run함수의 인자로 넘겨주게 됩니다. <code class=\"language-text\">index.js</code>를 보면 다음과 같은 부분이 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> crawl <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./src/puppeteer_utils.js\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>crawl<span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">...</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">run</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">userOptions<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> fs <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> fs<span class=\"token punctuation\">:</span> nativeFs <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> options<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    options <span class=\"token operator\">=</span> <span class=\"token function\">defaults</span><span class=\"token punctuation\">(</span>userOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token operator\">...</span>\n\n  <span class=\"token keyword\">await</span> <span class=\"token function\">crawl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    options<span class=\"token punctuation\">,</span>\n    <span class=\"token operator\">...</span></code></pre></div>\n<p>마지막으로 <strong>crawl</strong>함수를 보겠습니다. 이 파일은 <code class=\"language-text\">./src/puppeteer_utils.js</code>에 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">crawl</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">opt</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    options<span class=\"token punctuation\">,</span>\n    basePath<span class=\"token punctuation\">,</span>\n    beforeFetch<span class=\"token punctuation\">,</span>\n    afterFetch<span class=\"token punctuation\">,</span>\n    onEnd<span class=\"token punctuation\">,</span>\n    publicPath<span class=\"token punctuation\">,</span>\n    sourceDir\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> opt<span class=\"token punctuation\">;</span>\n\n  <span class=\"token operator\">...</span>\n\n  <span class=\"token keyword\">const</span> browser <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> puppeteer<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    headless<span class=\"token punctuation\">:</span> options<span class=\"token punctuation\">.</span>headless<span class=\"token punctuation\">,</span>\n    args<span class=\"token punctuation\">:</span> options<span class=\"token punctuation\">.</span>puppeteerArgs<span class=\"token punctuation\">,</span>\n    executablePath<span class=\"token punctuation\">:</span> options<span class=\"token punctuation\">.</span>puppeteerExecutablePath<span class=\"token punctuation\">,</span>\n    ignoreHTTPSErrors<span class=\"token punctuation\">:</span> options<span class=\"token punctuation\">.</span>puppeteerIgnoreHTTPSErrors<span class=\"token punctuation\">,</span>\n    handleSIGINT<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위와 같이 작성이 되어있는데, 에러 메세지에서 참고하라고 나온 <a href=\"https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md\">공식 문서</a>를 살펴보면 다음과 같은 부분이 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> browser <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> puppeteer<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> args<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'--no-sandbox'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'--disable-setuid-sandbox'</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이 부분처럼, <strong>args</strong>에 <code class=\"language-text\">--no-sandbox</code>옵션을 주면 해결할 수 있습니다. 최종적으로 <code class=\"language-text\">package.json</code>에 다음과 같이 추가해주면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"reactSnap\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  ...\n  <span class=\"token property\">\"puppeteerArgs\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">\"--no-sandbox\"</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"categories":["React"],"title":"React snap puppeteer no-sandbox","date":"Mar 01, 2019","tags":["React","build"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"comments":true,"previous":{"frontmatter":{"path":"/articles/2019-02/React-eject-없이-babelrc-적용","title":"React eject 없이 babelrc 적용","comments":true}},"next":{"frontmatter":{"path":"/articles/2019-03/Docker-사용하지-않는-이미지-제거","title":"Docker 사용하지 않는 이미지 제거","comments":true}}}}}